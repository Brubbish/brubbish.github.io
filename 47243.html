<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/unnamed.jpg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/photo.gif">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/logo.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="eaKNHevzJD712W6CICpiQ4_TgpzOgFr3dBKOwg7Hqs4">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"brubbish.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.8.0","exturl":true,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta name="description" content="本来打算只看看书，跳过调试的环节，结果在下一章堆漏洞讲到了分析这个漏洞时用到的栈回溯，所以又回来了2333">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2010-3333">
<meta property="og:url" content="https://brubbish.github.io/47243.html">
<meta property="og:site_name" content="Brubbish&#39;s">
<meta property="og:description" content="本来打算只看看书，跳过调试的环节，结果在下一章堆漏洞讲到了分析这个漏洞时用到的栈回溯，所以又回来了2333">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/Brubbish/pic_bed/master/blog/20210512215446.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Brubbish/pic_bed/master/blog/20210512215515.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Brubbish/pic_bed/master/blog/20210512220932.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Brubbish/pic_bed/master/blog/20210512222342.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Brubbish/pic_bed/master/blog/20210513182456.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Brubbish/pic_bed/master/blog/20210513184917.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Brubbish/pic_bed/master/blog/20210513200611.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Brubbish/pic_bed/master/blog/20210513210636.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Brubbish/pic_bed/master/blog/20210513211641.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Brubbish/pic_bed/master/blog/20210513212959.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Brubbish/pic_bed/master/blog/20210513213522.png">
<meta property="article:published_time" content="2021-10-05T12:49:39.033Z">
<meta property="article:modified_time" content="2021-07-25T14:23:18.615Z">
<meta property="article:author" content="Bruce">
<meta property="article:tag" content="Win漏洞分析">
<meta property="article:tag" content="漏洞战争">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/Brubbish/pic_bed/master/blog/20210512215446.png">


<link rel="canonical" href="https://brubbish.github.io/47243.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://brubbish.github.io/47243.html","path":"47243.html","title":"CVE-2010-3333"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>CVE-2010-3333 | Brubbish's</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-153514659-2"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-153514659-2","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Brubbish's</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-book-list"><a href="/books/" rel="section"><i class="fa fa-bookmark fa-fw"></i>Book List</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-9943095847270020"
     data-ad-slot="6634125020"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>

      </div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">1.</span> <span class="nav-text">漏洞描述</span></a></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">2.</span> <span class="nav-text">复现过程</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Bruce</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">42</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



        </div>
      </div>




<!-- sidebar -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-9943095847270020"
     data-ad-slot="5504766755"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
    </div>



  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://brubbish.github.io/47243.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Bruce">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Brubbish's">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          CVE-2010-3333
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-10-05 20:49:39" itemprop="dateCreated datePublished" datetime="2021-10-05T20:49:39+08:00">2021-10-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-07-25 22:23:18" itemprop="dateModified" datetime="2021-07-25T22:23:18+08:00">2021-07-25</time>
      </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>本来打算只看看书，跳过调试的环节，结果在下一章堆漏洞讲到了分析这个漏洞时用到的栈回溯，所以又回来了2333</p>
<span id="more"></span>
<table>
<thead>
<tr>
<th>项目</th>
<th>版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>操作系统</td>
<td>Windows XP SP3</td>
</tr>
<tr>
<td>调试器</td>
<td>windbg 6.12</td>
</tr>
<tr>
<td>漏洞软件</td>
<td>word 2003 (11.5604.5606)</td>
</tr>
</tbody>
</table>
<p>注：虽然漏洞好像在XP SP3上都有，但是metasploit生成的crash样本在高于11.5604的word上不一定能用（之前调试CVE-2011-0104用的那个office就8行，直接成功把样本打开了…）这个版本找了好久orzz</p>
<h1>漏洞描述</h1>
<p>Stack-based buffer overflow in Microsoft Office XP SP3, Office 2003 SP3, Office 2007 SP2, Office 2010, Office 2004 and 2008 for Mac, Office for Mac 2011, and Open XML File Format Converter for Mac allows remote attackers to execute arbitrary code via crafted RTF data, aka “RTF Stack Buffer Overflow Vulnerability.”</p>
<h1>复现过程</h1>
<p>用metasploit生成poc。<br>
感觉metasploit在windows上不太好使，后来想起来kali自带了这个…</p>
<p>获得poc后打开word，windbg attach，加载poc触发异常一条龙</p>
<p><img src="https://raw.githubusercontent.com/Brubbish/pic_bed/master/blog/20210512215446.png" alt="20210512215446"><br>
windbg查看寄存器信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">这一步需要符号文件，没有配置过的话可以参考下面两个链接</span><br><span class="line">https://bbs.pediy.com/thread-251052.htm</span><br><span class="line">https://www.cnblogs.com/csnd/p/11800535.html</span><br></pre></td></tr></table></figure>
<p>发现edi指向了一个只读的区域<br>
<img src="https://raw.githubusercontent.com/Brubbish/pic_bed/master/blog/20210512215515.png" alt="20210512215515"><br>
所以应该还是在循环复制的时候没有检查长度（似乎好多古老的栈溢出都是因为这个）</p>
<p>在异常处下断点，bp 30e9eb88，重新加载<br>
<img src="https://raw.githubusercontent.com/Brubbish/pic_bed/master/blog/20210512220932.png" alt="20210512220932"><br>
命令k查看栈回溯<br>
<img src="https://raw.githubusercontent.com/Brubbish/pic_bed/master/blog/20210512222342.png" alt="20210512222342"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">windbg查看反汇编代码指令：</span><br><span class="line">u .  // 反汇编当前eip寄存器地址的后8条指令</span><br><span class="line"></span><br><span class="line">u $eip  // 反汇编当前eip寄存器地址的后8条指令</span><br><span class="line"></span><br><span class="line">ub .  // 反汇编当前ip寄存器地址的前8条指令</span><br><span class="line"></span><br><span class="line">ub $eip  // 反汇编当前eip寄存器地址的前8条指令</span><br><span class="line"></span><br><span class="line">u main+0x29 L30 // 反汇编main+0x29地址的后30条指令</span><br><span class="line"></span><br><span class="line">u  // 反编译下8条指令</span><br><span class="line"></span><br><span class="line">uf CTest::add  // 反汇编CTest类的add函数</span><br><span class="line"></span><br><span class="line">uf /c main  // 反汇编main函数，通过/c可以查看main函数中的函数调用(call)都有哪些</span><br><span class="line"></span><br><span class="line">ub 000c135d L20  // 查看地址为000c135d指令前的20条指令内容</span><br></pre></td></tr></table></figure>
<p>查看后续的指令和栈中的内容。连着两个pop然后ret，返回到调用漏洞代码的指令的下一指令，即0x30f4cc96<br>
<img src="https://raw.githubusercontent.com/Brubbish/pic_bed/master/blog/20210513182456.png" alt="20210513182456"></p>
<p>在ida里查看，可以发现该指令位于函数sub_30F4CC5D<br>
<img src="https://raw.githubusercontent.com/Brubbish/pic_bed/master/blog/20210513184917.png" alt="20210513184917"><br>
并且函数有三个参数。因为是32位程序，使用栈传递参数，涉及到的三个push指令分别与[ebp+arg_4]（在后续的子函数中赋给edi，如下图2）、ecx、esi有关<br>
<img src="https://raw.githubusercontent.com/Brubbish/pic_bed/master/blog/20210513200611.png" alt="20210513200611"><br>
<img src="https://raw.githubusercontent.com/Brubbish/pic_bed/master/blog/20210513210636.png" alt="20210513210636"></p>
<p>先记录一下，这条call指令位于sub_20F4CC5D的30F4CC93，调用了sub_30E9EB62的30E9EB88（即溢出点）<br>
而我们要回溯它用到的三个参数。第一个很直白；2、3需要再分析</p>
<p>先看esi，esi=[eax+64h]，注意到有一个</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.text:30F4CC75                 call    sub_30D2810C</span><br></pre></td></tr></table></figure>
<p>进入看到这里是最后修改eax的位置<br>
<img src="https://raw.githubusercontent.com/Brubbish/pic_bed/master/blog/20210513211641.png" alt="20210513211641"></p>
<p>再看ecx，在sub_30E9EB62中：<br>
<img src="https://raw.githubusercontent.com/Brubbish/pic_bed/master/blog/20210513212959.png" alt="20210513212959"></p>
<p>在30F4CDB0中可以看到，eax=[ebp+arg_0]</p>
<p>综上得到：<br>
<img src="https://raw.githubusercontent.com/Brubbish/pic_bed/master/blog/20210513213522.png" alt="20210513213522"></p>
<p>在windbg中再次调试可以验证静态分析得到的传参过程，没截图，略</p>
<pre><code>整体思路：由崩溃点确定漏洞触发位置——&gt;回溯调用栈——&gt;分析参数如何计算及传递。
</code></pre>
<p>参考：<br>
<span class="exturl" data-url="aHR0cHM6Ly93d3cueXVxdWUuY29tL2h4ZnFnOS9iaW4vaHp5eHZr">https://www.yuque.com/hxfqg9/bin/hzyxvk<i class="fa fa-external-link-alt"></i></span><br>
<span class="exturl" data-url="aHR0cHM6Ly9iYnMucGVkaXkuY29tL3RocmVhZC0yNjM5OTguaHRt">https://bbs.pediy.com/thread-263998.htm<i class="fa fa-external-link-alt"></i></span></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Win%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" rel="tag"># Win漏洞分析</a>
              <a href="/tags/%E6%BC%8F%E6%B4%9E%E6%88%98%E4%BA%89/" rel="tag"># 漏洞战争</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/57740.html" rel="prev" title="CVE-2010-2883 Adobe Reader TFF字体SING表栈溢出漏洞">
                  <i class="fa fa-chevron-left"></i> CVE-2010-2883 Adobe Reader TFF字体SING表栈溢出漏洞
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/3418.html" rel="next" title="CVE-2011-0104 漏洞分析">
                  CVE-2011-0104 漏洞分析 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Bruce</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & <span class="exturl" data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZy9tdXNlLw==">NexT.Muse</span> 强力驱动
  </div>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9943095847270020"
     crossorigin="anonymous"></script>
<!-- 1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-9943095847270020"
     data-ad-slot="9629035599"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.css" integrity="sha256-M6KFoDq9eUpmogkDgw6+3R3ZgUPSuFXnQyr8tskSfQs=" crossorigin="anonymous">



</body>
</html>
